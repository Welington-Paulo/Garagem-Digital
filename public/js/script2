// JS/script.js
document.addEventListener('DOMContentLoaded', () => {
    // Assumindo que as classes Garagem, Veiculo, Carro, CarroEsportivo, Caminhao, Manutencao
    // estão definidas em seus respectivos arquivos .js e carregadas antes deste script no HTML.
    const garagem = new Garagem();

    // --- Elementos do DOM (Cache) ---
    const formAddVeiculo = document.getElementById('form-add-veiculo');
    const tipoVeiculoSelect = document.getElementById('tipo-veiculo');
    const camposEspecificosDivs = document.querySelectorAll('.campos-especificos');
    const garagemDisplayCards = document.getElementById('garagem-display-cards');
    
    const agendamentosFuturosViewDiv = document.getElementById('agendamentos-futuros-view');
    const lembretesManutencaoViewDiv = document.getElementById('lembretes-manutencao-view');
    const historicosConsolidadosViewDiv = document.getElementById('historicos-consolidados-view');
    const notificacaoArea = document.getElementById('notificacao-area');

    const navButtons = document.querySelectorAll('.nav-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const menuHamburgerBtn = document.getElementById('menu-hamburger-btn');
    const menuCloseBtn = document.getElementById('menu-close-btn');
    const mainNav = document.getElementById('main-nav');

    const nomeVeiculoInteracaoSpan = document.getElementById('nome-veiculo-interacao');
    const divInfoVeiculoSelecionado = document.getElementById('informacoesVeiculoSelecionado');
    const divBotoesAcoesComuns = document.getElementById('botoesAcoesComuns');
    const divBotoesAcoesEspecificas = document.getElementById('botoesAcoesEspecificas');
    const ulLogInteracoes = document.getElementById('logInteracoesVeiculo');

    const selectViagemVeiculo = document.getElementById('viagem-veiculo');
    const cityInputViagem = document.getElementById('cityInputViagem');
    const searchButtonViagem = document.getElementById('searchButtonViagem');
    const weatherResultDivViagem = document.getElementById('weatherResultViagem');
    const errorMessageDivViagem = document.getElementById('errorMessageViagem');

    const controlesPrevisaoDiv = document.getElementById('controles-previsao');
    const filtroDiasButtons = document.querySelectorAll('.btn-filtro-dias');
    const destaqueChuvaCheckbox = document.getElementById('destaque-chuva');
    const destaqueTempBaixaCheckbox = document.getElementById('destaque-temp-baixa');
    const destaqueTempAltaCheckbox = document.getElementById('destaque-temp-alta');

    const cardsVeiculosDestaqueDiv = document.getElementById('cards-veiculos-destaque');
    const listaServicosOferecidosUl = document.getElementById('lista-servicos-oferecidos');
    const filtroTipoVeiculoDicaSelect = document.getElementById('filtro-tipo-veiculo-dica');
    const dicasManutencaoViewDiv = document.getElementById('dicas-manutencao-view');

    const modalEditarVeiculo = document.getElementById('modal-editar-veiculo');
    const formEditarVeiculo = document.getElementById('form-editar-veiculo');
    const editarVeiculoIdInput = document.getElementById('editar-veiculo-id');
    const modalEditarTituloSpan = document.getElementById('modal-editar-veiculo-titulo');
    const camposEspecificosEditarDivs = document.querySelectorAll('.campos-especificos-editar');

    // **NOVOS** Elementos para a Seção de Manutenção
    const secaoManutencao = document.getElementById('secao-manutencao-veiculo');
    const listaManutencoesDiv = document.getElementById('lista-manutencoes-veiculo');
    const formAddManutencao = document.getElementById('form-add-manutencao');
    const manutencaoVeiculoIdInput = document.getElementById('manutencao-veiculo-id');

    let filtroDiasAtivo = 5;
    let destacarChuva = false;
    let destacarTempBaixa = false;
    let destacarTempAlta = false;
    let dadosCompletosForecastCache = null;
    let cidadeCache = "";
    let todasAsDicasCache = [];

    const backendBaseUrl = 'http://localhost:3001'; 
    let isSubmitting = false;

    function _renderFeatherIcons() {
        if (typeof feather !== 'undefined') {
            feather.replace({ width: '1em', height: '1em', class: 'feather-icon-inline' });
        }
    }

    // --- Lógica do Menu Hambúrguer e Abas (sem alterações) ---
    if (menuHamburgerBtn && mainNav && menuCloseBtn) {
        menuHamburgerBtn.addEventListener('click', () => {
            mainNav.setAttribute('data-visible', 'true');
            menuHamburgerBtn.setAttribute('aria-expanded', 'true');
        });
        menuCloseBtn.addEventListener('click', () => {
            mainNav.setAttribute('data-visible', 'false');
            menuHamburgerBtn.setAttribute('aria-expanded', 'false');
        });
    }
    if (navButtons && tabContents) {
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                navButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                const targetId = button.dataset.target;
                const targetTab = document.getElementById(targetId);
                if (targetTab) {
                    targetTab.classList.add('active');
                } else {
                    console.warn(`Aba com ID "${targetId}" não encontrada.`);
                }
                if (mainNav && mainNav.getAttribute('data-visible') === 'true') {
                    mainNav.setAttribute('data-visible', 'false');
                    if(menuHamburgerBtn) menuHamburgerBtn.setAttribute('aria-expanded', 'false');
                }
                _renderFeatherIcons();
            });
        });
    }

    // --- Sistema de Notificação (Toast - sem alterações) ---
    function exibirNotificacao(mensagem, tipo = 'info', duracao = 4000) {
        if (!notificacaoArea) { console.warn("Área de notificação (#notificacao-area) não encontrada."); return; }
        const notificacao = document.createElement('div');
        notificacao.className = `notificacao ${tipo}`;
        let iconName = 'info';
        if (tipo === 'sucesso') iconName = 'check-circle';
        else if (tipo === 'erro') iconName = 'x-octagon';
        else if (tipo === 'aviso') iconName = 'alert-triangle';
        notificacao.innerHTML = `<i data-feather="${iconName}"></i> <span style="margin-left: 10px;">${mensagem}</span>`;
        notificacaoArea.appendChild(notificacao);
        _renderFeatherIcons();
        void notificacao.offsetWidth; 
        notificacao.classList.add('show');
        setTimeout(() => {
            notificacao.classList.remove('show');
            setTimeout(() => { if (notificacao.parentNode) notificacao.parentNode.removeChild(notificacao); }, 500);
        }, duracao);
    }

    // --- API Simulada de Detalhes Veiculares (mantida) ---
    async function buscarDetalhesVeiculoApiSimulada(placa) {
        try {
            const response = await fetch('./data/api_veiculos_detalhes.json'); 
            if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
            const todosOsDetalhes = await response.json();
            return todosOsDetalhes[placa.toUpperCase().replace(/-/g, '')] || null;
        } catch (error) {
            console.error("Erro ao buscar detalhes na API simulada:", error);
            return null;
        }
    }

    // --- Renderização e Atualização da UI ---
    function renderizarTudoUI() {
        renderizarCardsVeiculosUI();
        atualizarPainelInteracaoUI(); 
        // ATENÇÃO: A lógica destas funções de consulta precisará ser adaptada
        // para buscar os dados de manutenção via API, se necessário.
        // Por enquanto, elas foram mantidas mas podem não refletir os dados do backend.
        renderizarAgendamentosFuturosView();
        renderizarLembretesManutencaoView();
        renderizarHistoricosConsolidadosView();
        preencherSelectVeiculosViagem();
    }

    function renderizarCardsVeiculosUI() {
        if (!garagemDisplayCards) return;
        garagemDisplayCards.innerHTML = garagem.listarVeiculosParaCards();
        document.querySelectorAll('.btn-card-selecionar').forEach(button => {
            button.addEventListener('click', (e) => {
                const placa = e.target.dataset.placa;
                if (garagem.selecionarVeiculoPorPlaca(placa)) { 
                    atualizarPainelInteracaoUI(); 
                    renderizarCardsVeiculosUI(); 
                }
            });
        });
        _renderFeatherIcons();
    }
    
    async function atualizarPainelInteracaoUI() {
        const veiculo = garagem.getVeiculoSelecionado();
        if (!nomeVeiculoInteracaoSpan || !divInfoVeiculoSelecionado) return;
            
        if (veiculo) {
            nomeVeiculoInteracaoSpan.textContent = `${veiculo.constructor.name} ${veiculo.modelo} (${veiculo.placa})`;
            divInfoVeiculoSelecionado.innerHTML = veiculo.exibirInformacoes(); 
            
            const carregandoDetalhesSpan = document.createElement('p');
            carregandoDetalhesSpan.id = 'loading-api-details';
            carregandoDetalhesSpan.innerHTML = '<i data-feather="loader" class="spin"></i> Buscando detalhes adicionais...';
            const hrExistente = divInfoVeiculoSelecionado.querySelector('.info-divider');
            if (hrExistente) divInfoVeiculoSelecionado.insertBefore(carregandoDetalhesSpan, hrExistente);
            else divInfoVeiculoSelecionado.appendChild(carregandoDetalhesSpan);
            _renderFeatherIcons();

            const detalhesApi = await buscarDetalhesVeiculoApiSimulada(veiculo.placa);
            const loadingSpanToRemove = document.getElementById('loading-api-details');
            if (loadingSpanToRemove) loadingSpanToRemove.remove();

            if (detalhesApi) {
                if (typeof veiculo.atualizarDetalhesDaApi === 'function') {
                    veiculo.atualizarDetalhesDaApi(detalhesApi);
                }
            }
            divInfoVeiculoSelecionado.innerHTML = veiculo.exibirInformacoes();

            document.querySelectorAll('.acao-especifica').forEach(el => el.style.display = 'none');
            if (veiculo instanceof CarroEsportivo) {
                document.querySelectorAll('.carroesportivo-action').forEach(el => el.style.display = (el.classList.contains('acao-com-input') ? 'flex' : 'inline-block'));
            } else if (veiculo instanceof Caminhao) {
                document.querySelectorAll('.caminhao-action').forEach(el => el.style.display = (el.classList.contains('acao-com-input') ? 'flex' : 'inline-block'));
            }
            if(divBotoesAcoesComuns) divBotoesAcoesComuns.style.display = 'block';
            if(divBotoesAcoesEspecificas) divBotoesAcoesEspecificas.style.display = 'block';

            // **NOVO**: Exibir e carregar a seção de manutenção
            if(secaoManutencao && manutencaoVeiculoIdInput) {
                secaoManutencao.style.display = 'block';
                manutencaoVeiculoIdInput.value = veiculo.id;
                const dataInput = document.getElementById('manutencao-data');
                if(dataInput) dataInput.value = new Date().toISOString().split('T')[0];
                carregarEExibirManutencoes(veiculo.id);
            }

        } else {
            nomeVeiculoInteracaoSpan.textContent = "Nenhum";
            divInfoVeiculoSelecionado.innerHTML = "<p>Selecione um veículo na aba \"Minha Garagem\" para interagir.</p>";
            if(divBotoesAcoesComuns) divBotoesAcoesComuns.style.display = 'none';
            if(divBotoesAcoesEspecificas) divBotoesAcoesEspecificas.style.display = 'none';
            if (secaoManutencao) secaoManutencao.style.display = 'none'; // Esconde a nova seção
        }
        window.atualizarLogInteracoesUI();
        _renderFeatherIcons();
    }

    window.atualizarLogInteracoesUI = function() { 
        if (!ulLogInteracoes) return;
        ulLogInteracoes.innerHTML = garagem.getHistoricoInteracoesFormatado();
    }

    // Lógica das abas de Consultas (precisaria ser adaptada para usar a API)
    function renderizarAgendamentosFuturosView() { if (!agendamentosFuturosViewDiv) return; agendamentosFuturosViewDiv.innerHTML = '<p>Funcionalidade em desenvolvimento.</p>'; }
    function renderizarLembretesManutencaoView() { if (!lembretesManutencaoViewDiv) return; lembretesManutencaoViewDiv.innerHTML = '<p>Funcionalidade em desenvolvimento.</p>'; }
    function renderizarHistoricosConsolidadosView() { if (!historicosConsolidadosViewDiv) return; historicosConsolidadosViewDiv.innerHTML = '<p>Funcionalidade em desenvolvimento.</p>'; }

    function preencherSelectVeiculosViagem() { 
        if (!selectViagemVeiculo) return;
        const valAnt = selectViagemVeiculo.value;
        selectViagemVeiculo.innerHTML = '<option value="">-- Selecione um Veículo --</option>';
        garagem.veiculos.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.placa;
            opt.textContent = `${v.constructor.name} ${v.modelo} (${v.placa})`;
            selectViagemVeiculo.appendChild(opt);
        });
        if (garagem.encontrarVeiculo(valAnt)) selectViagemVeiculo.value = valAnt;
    }

    // --- Lógica de Adicionar Veículo (sem alterações) ---
    if (tipoVeiculoSelect) tipoVeiculoSelect.addEventListener('change', () => { 
        if (!camposEspecificosDivs) return;
        camposEspecificosDivs.forEach(div => div.style.display = 'none');
        const valorSelecionado = tipoVeiculoSelect.value.toLowerCase();
        if (valorSelecionado) { 
            const divToShow = document.getElementById(`campos-${valorSelecionado}`);
            if (divToShow) divToShow.style.display = 'block';
        }
    });

    if (formAddVeiculo) { 
        formAddVeiculo.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isSubmitting) return;
            isSubmitting = true; 
            const submitButton = formAddVeiculo.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i data-feather="loader" class="spin"></i> Salvando...';
                _renderFeatherIcons();
            }
            const fd = new FormData(formAddVeiculo);
            const dadosVeiculo = {
                placa: fd.get('placa')?.toUpperCase().trim().replace(/-/g, ''),
                marca: fd.get('marca')?.trim(),
                modelo: fd.get('modelo')?.trim(),
                ano: fd.get('ano') ? parseInt(fd.get('ano')) : null,
                cor: fd.get('cor')?.trim() || "Não informada",
                tipoVeiculo: fd.get('tipo-veiculo'),
                detalhes: {}
            };
            if (!dadosVeiculo.tipoVeiculo || !dadosVeiculo.marca || !dadosVeiculo.modelo || !dadosVeiculo.ano || !dadosVeiculo.placa) {
                exibirNotificacao("Por favor, preencha todos os campos obrigatórios.", 'erro');
                isSubmitting = false; 
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i data-feather="save"></i> Salvar Veículo';
                    _renderFeatherIcons();
                }
                return;
            }
            switch (dadosVeiculo.tipoVeiculo) {
                case 'Carro': dadosVeiculo.detalhes.numeroPortas = parseInt(fd.get('numero-portas')) || 4; break;
                case 'CarroEsportivo': dadosVeiculo.detalhes.velocidadeMaximaTurbo = parseInt(fd.get('velocidade-maxima-turbo')) || 250; break;
                case 'Caminhao': dadosVeiculo.detalhes.capacidadeCarga = parseFloat(fd.get('capacidade-carga')) || 1000; break;
            }
            try {
                const response = await fetch(`${backendBaseUrl}/api/veiculos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosVeiculo),
                });
                const resultado = await response.json();
                if (!response.ok) throw new Error(resultado.error);
                exibirNotificacao(`Veículo ${resultado.modelo} adicionado com sucesso!`, 'sucesso');
                formAddVeiculo.reset();
                if(tipoVeiculoSelect) tipoVeiculoSelect.dispatchEvent(new Event('change'));
                await carregarVeiculosDoBackend(); 
            } catch (error) {
                exibirNotificacao(`Erro ao adicionar veículo: ${error.message}`, 'erro');
                console.error("Erro no POST do veículo:", error);
            } finally {
                isSubmitting = false;
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i data-feather="save"></i> Salvar Veículo';
                    _renderFeatherIcons();
                }
            }
        });
    }

    // --- Lógica de Interação com Veículo (sem alterações) ---
    const todosBotoesDeAcao = [ 
        ...(divBotoesAcoesComuns ? divBotoesAcoesComuns.querySelectorAll('button[data-acao]') : []),
        ...(divBotoesAcoesEspecificas ? divBotoesAcoesEspecificas.querySelectorAll('button[data-acao], .acao-com-input button[data-acao]') : [])
    ];
    todosBotoesDeAcao.forEach(button => { 
        button.addEventListener('click', () => {
            const veiculoSel = garagem.getVeiculoSelecionado();
            if (!veiculoSel) { exibirNotificacao("Nenhum veículo selecionado para interagir.", "aviso"); return; }
            const acao = button.dataset.acao; 
            let valor = null;
            const inputCargaEl = document.getElementById('input-carga'); 
            const inputDescargaEl = document.getElementById('input-descarga');
            if (acao === "carregar" && inputCargaEl) valor = inputCargaEl.value;
            else if (acao === "descarregar" && inputDescargaEl) valor = inputDescargaEl.value;
            garagem.interagirComSelecionado(acao, valor); 
            atualizarPainelInteracaoUI(); 
            renderizarCardsVeiculosUI(); 
        });
    });

    // --- **NOVA** Lógica de Manutenção ---

    /**
     * Carrega as manutenções de um veículo do backend e as exibe na tela.
     * @param {string} veiculoId O ID do veículo.
     */
    async function carregarEExibirManutencoes(veiculoId) {
        if (!listaManutencoesDiv) return;
        listaManutencoesDiv.innerHTML = `<p class="placeholder"><i data-feather="loader" class="spin"></i> Carregando histórico...</p>`;
        _renderFeatherIcons();

        try {
            const response = await fetch(`${backendBaseUrl}/api/veiculos/${veiculoId}/manutencoes`);
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || `Erro HTTP ${response.status}`);
            }
            const manutencoes = await response.json();

            if (manutencoes.length === 0) {
                listaManutencoesDiv.innerHTML = '<p class="placeholder">Nenhum registro de manutenção encontrado.</p>';
                return;
            }

            let html = '<ul>';
            manutencoes.forEach(m => {
                const dataFormatada = new Date(m.data).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                const custoFormatado = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(m.custo);
                html += `
                    <li class="manutencao-item">
                        <div class="manutencao-info">
                            <strong>${m.descricaoServico}</strong>
                            <span>${dataFormatada} - ${custoFormatado}</span>
                        </div>
                        ${m.quilometragem ? `<span class="manutencao-km">${m.quilometragem.toLocaleString('pt-BR')} km</span>` : ''}
                    </li>
                `;
            });
            html += '</ul>';
            listaManutencoesDiv.innerHTML = html;

        } catch (error) {
            console.error("Erro ao carregar manutenções:", error);
            listaManutencoesDiv.innerHTML = `<p class="placeholder erro"><i data-feather="alert-triangle"></i> Falha ao carregar histórico: ${error.message}</p>`;
            _renderFeatherIcons();
        }
    }

    // Event listener para o novo formulário de manutenção
    if (formAddManutencao) {
        formAddManutencao.addEventListener('submit', async (e) => {
            e.preventDefault();
            const veiculoId = manutencaoVeiculoIdInput.value;
            if (!veiculoId) {
                exibirNotificacao("ID do veículo não encontrado. Selecione um veículo.", 'erro');
                return;
            }

            const submitButton = formAddManutencao.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i data-feather="loader" class="spin"></i> Salvando...';
            _renderFeatherIcons();

            const dadosFormulario = {
                descricaoServico: document.getElementById('manutencao-descricao').value,
                data: document.getElementById('manutencao-data').value,
                custo: parseFloat(document.getElementById('manutencao-custo').value),
                quilometragem: document.getElementById('manutencao-km').value ? parseInt(document.getElementById('manutencao-km').value) : undefined
            };
            
            if (isNaN(dadosFormulario.quilometragem)) {
                delete dadosFormulario.quilometragem;
            }

            try {
                const response = await fetch(`${backendBaseUrl}/api/veiculos/${veiculoId}/manutencoes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosFormulario),
                });
                const resultado = await response.json();
                if (!response.ok) {
                    throw new Error(resultado.error || `Erro HTTP ${response.status}`);
                }
                exibirNotificacao('Manutenção adicionada com sucesso!', 'sucesso');
                formAddManutencao.reset();
                const dataInput = document.getElementById('manutencao-data');
                if (dataInput) dataInput.value = new Date().toISOString().split('T')[0];
                await carregarEExibirManutencoes(veiculoId);
            } catch (error) {
                exibirNotificacao(`Erro ao salvar manutenção: ${error.message}`, 'erro');
                console.error('Erro no POST de manutenção:', error);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i data-feather="save"></i> Salvar Manutenção';
                _renderFeatherIcons();
            }
        });
    }

    // Lógica de Remover Veículo
    window.confirmarRemocaoVeiculo = async (id, modeloInfo) => { 
        if (confirm(`Tem certeza que deseja remover ${modeloInfo}? Esta ação não pode ser desfeita.`)) {
            try {
                const response = await fetch(`${backendBaseUrl}/api/veiculos/${id}`, {
                    method: 'DELETE',
                });
                const resultado = await response.json();
                if (!response.ok) {
                    throw new Error(resultado.error || 'Erro ao remover veículo.');
                }
                exibirNotificacao(resultado.message, 'sucesso');
                await carregarVeiculosDoBackend();
            } catch (error) {
                exibirNotificacao(error.message, 'erro');
            }
        }
    };

    // Lógica de Edição de Veículo (sem alterações)
    window.abrirModalEdicao = (id) => {
        const veiculo = garagem.encontrarVeiculoPorId(id);
        if (veiculo && modalEditarVeiculo) {
            modalEditarTituloSpan.textContent = `${veiculo.modelo} (${veiculo.placa})`;
            editarVeiculoIdInput.value = veiculo.id;
            document.getElementById('editar-marca').value = veiculo.marca;
            document.getElementById('editar-modelo').value = veiculo.modelo;
            document.getElementById('editar-ano').value = veiculo.ano;
            document.getElementById('editar-cor').value = veiculo.cor;
            camposEspecificosEditarDivs.forEach(div => div.style.display = 'none');
            const tipo = veiculo.constructor.name;
            if (tipo === 'Carro' || tipo === 'CarroEsportivo') {
                 document.getElementById('campos-editar-carro').style.display = 'block';
                 document.getElementById('editar-numero-portas').value = veiculo.numeroPortas || '';
            }
            if (tipo === 'CarroEsportivo') {
                 document.getElementById('campos-editar-carroesportivo').style.display = 'block';
                 document.getElementById('editar-velocidade-maxima-turbo').value = veiculo.velocidadeMaximaTurbo || '';
            }
            if (tipo === 'Caminhao') {
                 document.getElementById('campos-editar-caminhao').style.display = 'block';
                 document.getElementById('editar-capacidade-carga').value = veiculo.capacidadeCarga || '';
            }
            modalEditarVeiculo.style.display = 'block';
            _renderFeatherIcons();
        } else {
            exibirNotificacao("Não foi possível encontrar o veículo para editar.", 'erro');
        }
    };
    window.fecharModalEdicao = () => { if(modalEditarVeiculo) modalEditarVeiculo.style.display = 'none'; };
    window.addEventListener('click', (event) => { if (modalEditarVeiculo && event.target === modalEditarVeiculo) fecharModalEdicao(); });
    if(formEditarVeiculo) {
        formEditarVeiculo.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editarVeiculoIdInput.value;
            const submitButton = formEditarVeiculo.querySelector('button[type="submit"]');
            const dadosAtualizados = {
                marca: document.getElementById('editar-marca').value.trim(),
                modelo: document.getElementById('editar-modelo').value.trim(),
                ano: parseInt(document.getElementById('editar-ano').value),
                cor: document.getElementById('editar-cor').value.trim() || "Não informada",
                detalhes: {}
            };
            const numPortasInput = document.getElementById('editar-numero-portas');
            if (numPortasInput && numPortasInput.closest('.campos-especificos-editar').style.display !== 'none') dadosAtualizados.detalhes.numeroPortas = parseInt(numPortasInput.value);
            const velTurboInput = document.getElementById('editar-velocidade-maxima-turbo');
            if (velTurboInput && velTurboInput.closest('.campos-especificos-editar').style.display !== 'none') dadosAtualizados.detalhes.velocidadeMaximaTurbo = parseInt(velTurboInput.value);
            const cargaInput = document.getElementById('editar-capacidade-carga');
            if (cargaInput && cargaInput.closest('.campos-especificos-editar').style.display !== 'none') dadosAtualizados.detalhes.capacidadeCarga = parseFloat(cargaInput.value);
            submitButton.disabled = true;
            submitButton.innerHTML = '<i data-feather="loader" class="spin"></i> Salvando...';
            _renderFeatherIcons();
            try {
                const response = await fetch(`${backendBaseUrl}/api/veiculos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosAtualizados),
                });
                const resultado = await response.json();
                if (!response.ok) throw new Error(resultado.error || `Erro ${response.status} ao atualizar veículo.`);
                exibirNotificacao(`Veículo ${resultado.modelo} atualizado com sucesso!`, 'sucesso');
                fecharModalEdicao();
                await carregarVeiculosDoBackend();
            } catch (error) {
                exibirNotificacao(`Erro ao atualizar veículo: ${error.message}`, 'erro');
                console.error("Erro no PUT do veículo:", error);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i data-feather="save"></i> Salvar Alterações';
                _renderFeatherIcons();
            }
        });
    }

    // --- Lógica do Planejador de Viagem (sem alterações) ---
    async function fetchWeatherFromBackend(city, type = 'forecast') { /* ...código existente... */ }
    function processarDadosForecast(dataForecast) { /* ...código existente... */ }
    function exibirPrevisaoDetalhadaUI(previsaoProcessada, nomeCidadeApi) { /* ...código existente... */ }
    function adicionarListenersCardsPrevisao(diasExibidos) { /* ...código existente... */ }
    if (searchButtonViagem) searchButtonViagem.addEventListener('click', async () => { const city = cityInputViagem ? cityInputViagem.value.trim() : null; const dadosApi = await fetchWeatherFromBackend(city, 'forecast'); if (dadosApi) { dadosCompletosForecastCache = processarDadosForecast(dadosApi); cidadeCache = dadosApi.city?.name || city; if (dadosCompletosForecastCache) { exibirPrevisaoDetalhadaUI(dadosCompletosForecastCache, cidadeCache); } else if (weatherResultDivViagem) { weatherResultDivViagem.innerHTML = `<p class="placeholder">Erro ao processar previsão.</p>`; } } });
    if (cityInputViagem) cityInputViagem.addEventListener('keypress', (e) => { if (e.key === 'Enter' && searchButtonViagem) searchButtonViagem.click(); });
    if (filtroDiasButtons) filtroDiasButtons.forEach(b => b.addEventListener('click', () => { filtroDiasAtivo = parseInt(b.dataset.dias); filtroDiasButtons.forEach(btn => btn.classList.remove('active')); b.classList.add('active'); if (dadosCompletosForecastCache) exibirPrevisaoDetalhadaUI(dadosCompletosForecastCache, cidadeCache); }));
    if (destaqueChuvaCheckbox) destaqueChuvaCheckbox.addEventListener('change', () => { destacarChuva = destaqueChuvaCheckbox.checked; if (dadosCompletosForecastCache) exibirPrevisaoDetalhadaUI(dadosCompletosForecastCache, cidadeCache); });
    if (destaqueTempBaixaCheckbox) destaqueTempBaixaCheckbox.addEventListener('change', () => { destacarTempBaixa = destaqueTempBaixaCheckbox.checked; if (dadosCompletosForecastCache) exibirPrevisaoDetalhadaUI(dadosCompletosForecastCache, cidadeCache); });
    if (destaqueTempAltaCheckbox) destaqueTempAltaCheckbox.addEventListener('change', () => { destacarTempAlta = destaqueTempAltaCheckbox.checked; if (dadosCompletosForecastCache) exibirPrevisaoDetalhadaUI(dadosCompletosForecastCache, cidadeCache); });

    // --- Funções para buscar dados do Backend ---
    async function carregarVeiculosDoBackend() {
        try {
            const response = await fetch(`${backendBaseUrl}/api/veiculos`);
            if (!response.ok) throw new Error('Falha ao buscar veículos do servidor.');
            const veiculosDoDb = await response.json();
            garagem.veiculos = []; 
            veiculosDoDb.forEach(jsonVeiculo => {
                try {
                    const veiculo = Veiculo.fromJSON(jsonVeiculo); 
                    garagem.adicionarVeiculo(veiculo);
                } catch (e) {
                    console.error("Erro ao processar veículo do DB:", jsonVeiculo, e);
                }
            });
            renderizarTudoUI(); 
            exibirNotificacao("Garagem sincronizada com o banco de dados.", 'info');
        } catch (error) {
            console.error("Erro ao carregar veículos do backend:", error);
            exibirNotificacao(error.message, 'erro');
        }
    }

    async function carregarVeiculosDestaque() { /* ...código existente... */ }
    async function carregarServicosGaragem() { /* ...código existente... */ }
    async function carregarTodasAsDicasDoBackend() { /* ...código existente... */ }
    function renderizarDicasFiltradas() { /* ...código existente... */ }
    if (filtroTipoVeiculoDicaSelect) filtroTipoVeiculoDicaSelect.addEventListener('change', renderizarDicasFiltradas);

    // --- INICIALIZAÇÃO DA APLICAÇÃO ---
    function inicializarApp() {
        carregarVeiculosDoBackend();
        carregarVeiculosDestaque();
        carregarServicosGaragem();
        carregarTodasAsDicasDoBackend();
        if(tipoVeiculoSelect) tipoVeiculoSelect.dispatchEvent(new Event('change')); 
        if(controlesPrevisaoDiv) controlesPrevisaoDiv.style.display = 'none'; 
        if (navButtons.length > 0 && !document.querySelector('.nav-button.active')) navButtons[0].click();
        _renderFeatherIcons();
        console.log("Aplicação da Garagem inicializada com sucesso, conectada ao backend.");
    }

    inicializarApp();

});